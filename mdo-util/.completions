#!/usr/bin/env bash

# replace all instances of mdo-util with the name of your command (without squigly-braces).
# hide unwanted targets (e.g. make-do provided targets) with patterns in $blacklist

# Set COMPREPLY to an array of discovered completions
_mdo-util_completions()
{
  # sed patterns to exclude targets
  # \b matches whole-words only
  blacklist=( '\brequire-env-%' '\bMakefile' '\ball')

  MAKE_TARGET_WORDS=$(mdo-util -p -q --dry-run | awk -F':' '/^[a-zA-Z0-9][^$#\/\t=]*:([^=]|$)/ {split($1,A,/ /);for(i in A)print A[i]}' | sort | uniq )

  for bad in ${blacklist[@]};
  do
    MAKE_TARGET_WORDS=$( echo ${MAKE_TARGET_WORDS} | sed -e s/$bad//g )
  done
  COMPLETE_WORDS=${MAKE_TARGET_WORDS}

  # parens are necessary to create an array
  # xargs accumulates multiple lines into one line
  COMPREPLY=( $(compgen -W "$COMPLETE_WORDS" ${COMP_WORDS[COMP_CWORD]} | xargs) )
  return 0
}

complete -F _mdo-util_completions mdo-util
