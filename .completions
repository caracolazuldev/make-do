#!/usr/bin/env bash

_mdo_completions()
{
  # sed patterns to exclude targets
  # \b matches on word-boundries
  blacklist=( '\brequire-env-%' '\bMakefile' '\ball')

  MAKE_TARGET_WORDS=$(mdo -p -q --dry-run | awk -F':' '/^[a-zA-Z0-9][^$#\/\t=]*:([^=]|$)/ {split($1,A,/ /);for(i in A)print A[i]}' | sort | uniq )

  for bad in ${blacklist[@]};
  do
    MAKE_TARGET_WORDS=$( echo ${MAKE_TARGET_WORDS} | sed -e s/$bad//g )
  done
  COMPLETE_WORDS=${MAKE_TARGET_WORDS}

  # parens are necessary to create an array
  # xargs accumulates multiple lines into one line
  COMPREPLY=( $(compgen -W "$COMPLETE_WORDS" ${COMP_WORDS[COMP_CWORD]} | xargs) )
  return 0
}

complete -F _mdo_completions mdo
